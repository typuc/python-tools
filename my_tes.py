import json
import requests
import datetime
from elasticsearch7 import Elasticsearch, ConnectionError
url = "http://alertmanager.test0.highso.com.cn/api/v1/alerts"
resp = requests.get(url, timeout=10)
data = resp.json()['data']
now = datetime.datetime.now().strftime('%Y-%m-%dT%H:%M:%S+08:00')

for i in range(len(data)):
    alertname = data[i]['labels']['alertname']
    if 'container' in data[i]['labels']:
        json_data = dict()
        json_data['@timestamp'] = datetime.datetime.now().strftime('%Y-%m-%dT%H:%M:%S+08:00')
        json_data['startsAt'] = data[i]['startsAt']
        json_data['alertname'] = data[i]['labels']['alertname']
        json_data['app_name'] = data[i]['labels']['container']
        json_data['env'] = data[i]['labels']['container']
        json_data['pod'] = data[i]['labels']['pod']
        json_data['description'] = data[i]['annotations']['description']
        json_data['fingerprint'] = data[i]['fingerprint']


        es = Elasticsearch('192.168.16.213:9205', timeout=10)

        es.index(index="xrf_test", body=a)


# data = [{"id":22491,"name":"datasource.crmdata.master.connectionProperties","type":"ITEM","value":"config.decrypt=true"},{"id":22493,"name":"datasource.crmdata.master.password","type":"ITEM","value":"CU26tqhK+zGBO/jYTp4fzeIaHQl4Rshw5oLBXJyCNamye+bqlAsBgLwszZIQklwp1HyDdYivlXYK9ghZFEHAQw=="},{"id":22495,"name":"datasource.crmdata.master.url","type":"ITEM","value":"jdbc:mysql://reg.mysql-crm.master-node1.highso.local:3308/crm?useUnicode=true&characterEncoding=utf8"},{"id":22497,"name":"datasource.crmdata.master.username","type":"ITEM","value":"reg_com_svc"},{"id":22499,"name":"datasource.crmdata.slave[0].connectionProperties","type":"ITEM","value":"config.decrypt=true"},{"id":22501,"name":"datasource.crmdata.slave[0].password","type":"ITEM","value":"CU26tqhK+zGBO/jYTp4fzeIaHQl4Rshw5oLBXJyCNamye+bqlAsBgLwszZIQklwp1HyDdYivlXYK9ghZFEHAQw=="},{"id":22503,"name":"datasource.crmdata.slave[0].url","type":"ITEM","value":"jdbc:mysql://reg.mysql-crm.master-node1.highso.local:3308/crm?useUnicode=true&characterEncoding=utf8"},{"id":22505,"name":"datasource.crmdata.slave[0].username","type":"ITEM","value":"reg_com_svc"},{"id":22507,"name":"disclient.import","type":"ITEM","value":"infra:1.0.0,crminfra:1.0.0"},{"id":22509,"name":"dubbo.zookeeper","type":"ITEM","value":"reg.zookeeper-common.node1.highso.local:2181"},{"id":22513,"name":"logging.level.root","type":"ITEM","value":"INFO"},{"id":22515,"name":"logging.path","type":"ITEM","value":"./logs"},{"id":22517,"name":"redis.namespace","type":"ITEM","value":"crm"},{"id":22519,"name":"spring.profiles.active","type":"ITEM","value":"dev"},{"id":22521,"name":"spring.redis.cluster.nodes","type":"ITEM","value":"reg.redis-crm.node1.highso.local:7001,reg.redis-crm.node2.highso.local:7002,reg.redis-crm.node3.highso.local:7003"},{"id":22523,"name":"swagger.dubbo.enable","type":"ITEM","value":"true"},{"id":22525,"name":"spring.rabbitmq.addresses","type":"ITEM","value":"reg.rabbitmq-common.node1.highso.local:5672,reg.rabbitmq-common.node2.highso.local:5674,reg.rabbitmq-common.node3.highso.local:5676"},{"id":22527,"name":"spring.rabbitmq.password","type":"ITEM","value":"admin"},{"id":22529,"name":"spring.rabbitmq.username","type":"ITEM","value":"admin"},{"id":24031,"name":"centre.com.tags","type":"ITEM","value":"5,69,73,77"},{"id":24033,"name":"channelClassify.platCodes","type":"ITEM","value":"JinRiTouTiao,GuangDianTong,DQ360"},{"id":24715,"name":"spring.data.elasticsearch.cluster-name","type":"ITEM","value":"crm"},{"id":24717,"name":"spring.data.elasticsearch.cluster-nodes","type":"ITEM","value":"reg.es-crm.data-node1.highso.local:9302,reg.es-crm.data-node2.highso.local:9322"},{"id":24719,"name":"kafka.consumer.servers","type":"ITEM","value":"reg.confluent-common.node1.highso.local:9092,reg.confluent-common.node2.highso.local:9092,reg.confluent-common.node3.highso.local:9092"},{"id":24721,"name":"kafka.consumer.group.id","type":"ITEM","value":"itp_binlog"},{"id":26261,"name":"es.chance.detail.wait.time","type":"ITEM","value":"200"},{"id":26285,"name":"infra.commons.auth.secret","type":"ITEM","value":"d0de6344-598b-4b73-9a23-728a1368d2da"},{"id":26439,"name":"chance.count.redis.expire.minutes","type":"ITEM","value":"3"},{"id":26749,"name":"spring.redis.jedis.pool.max-active","type":"ITEM","value":"20"},{"id":26751,"name":"spring.redis.jedis.pool.max-idle","type":"ITEM","value":"8"},{"id":26753,"name":"spring.redis.timeout","type":"ITEM","value":"5000"},{"id":26755,"name":"spring.redis.jedis.pool.max-wait","type":"ITEM","value":"2000"},{"id":26757,"name":"ucenter.sso.system-code","type":"ITEM","value":"crm"},{"id":26759,"name":"ucenter.sso.filter.login.exclude-pattern","type":"ITEM","value":"/mi/*,/favicon.ico,/swagger*"},{"id":26897,"name":"ucenter.login.url","type":"ITEM","value":"http://ucenter.reg.highso.com.cn/login?loginPageUrl=http://antd.k2.reg.highso.com.cn"},{"id":27005,"name":"inspection.url","type":"ITEM","value":"http://36.110.7.186:8898/record/"},{"id":27007,"name":"inspection.switchCase","type":"ITEM","value":"open"},{"id":27025,"name":"hub.collector.app-key","type":"ITEM","value":"4d9d8d7728d248198ddd81bc8d593f4d"},{"id":27027,"name":"hub.collector.debug","type":"ITEM","value":"false"},{"id":27029,"name":"hub.collector.kafka.bootstrap.servers","type":"ITEM","value":"reg.confluent-common.node1.highso.local:9092,reg.confluent-common.node2.highso.local:9094,reg.confluent-common.node3.highso.local:9096"},{"id":27031,"name":"hub.collector.topic","type":"ITEM","value":"haixue_hub_log_message_collect_2"},{"id":27041,"name":"logging.level.com.haixue.itp.chance","type":"ITEM","value":"DEBUG"},{"id":27105,"name":"es.sync.error.event.debug","type":"ITEM","value":"true"},{"id":27233,"name":"inspection.text.url","type":"ITEM","value":"http://36.110.7.186:5123/text/"},{"id":27235,"name":"inspection.pushWxWorkSwitch","type":"ITEM","value":"open"},{"id":27237,"name":"inspection.coopids","type":"ITEM","value":"wwa91dc08c44c27880"},{"id":27253,"name":"spring.kafka.bootstrap-servers","type":"ITEM","value":"reg.confluent-common.node1.highso.local:9092,reg.confluent-common.node2.highso.local:9094,reg.confluent-common.node3.highso.local:9096"},{"id":27287,"name":"itp.relay.highTopics","type":"ITEM","value":"common_canal_itp_relay_high_1,common_canal_itp_relay_high_2,common_canal_itp_relay_high_4"},{"id":27289,"name":"itp.relay.middleTopics","type":"ITEM","value":"common_canal_itp_relay_middle_1,common_canal_itp_relay_middle_2,common_canal_itp_relay_middle_4"},{"id":27291,"name":"itp.relay.lowTopics","type":"ITEM","value":"common_canal_itp_relay_low_1,common_canal_itp_relay_low_2,common_canal_itp_relay_low_4"},{"id":27293,"name":"relay.grey.groupId","type":"ITEM","value":"1238,1225"},{"id":27295,"name":"chance.assgin.record.startType","type":"ITEM","value":"{\"high\":\"1,2,6,7,8,10,16,17,22,27,28,30,31,37,41,43\",\"middle\":\"4,9,11,12,18,9,29,32,38,42\",\"low\":\"5,14,15,33,36,39,23,24,25\"}"},{"id":27297,"name":"chance.assgin.record.endType","type":"ITEM","value":"{\"high\":\"1,2\",\"middle\":\"\",\"low\":\"3\"}"},{"id":27785,"name":"test001","type":"ITEM","value":"\\u652f\\u4ed8\\u5b9d"},{"id":27787,"name":"online.pay","type":"ITEM","value":" {\"1\":\"\\u652f\\u4ed8\\u5b9d\",\"3\":\"\\u7f51\\u94f6\\u5728\\u7ebf\",\"4\":\"\\u5feb\\u94b1\",\"5\":\"\\u4ee3\\u7406\\u5546\\u5f00\\u901a\",\"8\":\"\\u94f6\\u8054\\u5728\\u7ebf\",\"9\":\"\\u8bfe\\u7a0b\\u5361\",\"10\":\"\\u6613\\u8054\\u8bed\\u97f3\",\"11\":\"\\u9996\\u4fe1\\u6613\",\"12\":\"\\u4e30\\u4ed8\",\"15\":\"\\u5fae\\u4fe1\\u626b\\u7801\\u652f\\u4ed8\",\"16\":\"\\u79fb\\u52a8\\u652f\\u4ed8-\\u5fae\\u4fe1\",\"17\":\"\\u79fb\\u52a8\\u652f\\u4ed8-\\u652f\\u4ed8\\u5b9d\",\"18\":\"\\u79fb\\u52a8\\u652f\\u4ed8-\\u82f9\\u679c\",\"19\":\"\\u6709\\u8d1d\\u5206\\u671f\",\"20\":\"\\u5317\\u94f6\\u5206\\u671f\",\"22\":\"\\u4eac\\u4e1c\\u652f\\u4ed8\",\"23\":\"\\u4eac\\u4e1c\\u767d\\u6761\",\"25\":\"\\u5496\\u5561\\u6613\\u878d\",\"26\":\"\\u767e\\u5ea6\\u6709\\u94b1\\u82b1\\u6613\\u878d\",\"27\":\"\\u5929\\u732b\\u5145\\u503c\\u5361\",\"29\":\"\\u91cd\\u4fee\",\"30\":\"\\u9752\\u8471\\u878d\",\"31\":\"\\u94f6\\u884c\\u6c47\\u6b3e\",\"32\":\"\\u5e93\\u5206\\u671f\",\"33\":\"\\u82b1\\u5457\\u5206\\u671f\",\"34\":\"\\u5496\\u5561\\u96f6\\u96f6\\u8d2d\",\"35\":\"\\u6c11\\u751f\\u5206\\u671f\",\"36\":\"\\u5fae\\u4fe1-\\u9074\\u9009\",\"37\":\"\\u652f\\u4ed8\\u5b9d-\\u9074\\u9009\",\"38\":\"\\u4eac\\u4e1c\\u767d\\u6761-\\u9074\\u9009\",\"39\":\"\\u8da3\\u5b66\\u5457\",\"40\":\"\\u94f6\\u5546\\u5fae\\u4fe1\",\"41\":\"\\u94f6\\u5546\\u652f\\u4ed8\\u5b9d\",\"42\":\"\\u878d\\u6613\\u5206\\u671f\",\"43\":\"\\u5929\\u732b\\u5145\\u503c\\u5361(\\u5206\\u671f)\",\"47\":\"\\u82b1\\u5457\\u6708\\u6708\\u4ed8\",\"48\":\"\\u5f00\\u653e\\u5e73\\u53f0\",\"49\":\"\\u829d\\u6613\\u5b66\",\"50\":\"\\u4e2d\\u94f6\\u652f\\u4ed8\",\"51\":\"\\u5206\\u4ed8\\u541b\",\"52\":\"\\u96f6\\u96f6\\u8d2d\",\"53\":\"\\u5ea6\\u5c0f\\u6ee1\\u91d1\\u878d\",\"54\":\"\\u5c0f\\u96e8\\u70b9\\u5206\\u671f\"}"}]
# for i in range(len(data)):
#     print("{}={}".format(data[i]['name'],data[i]['value']))
